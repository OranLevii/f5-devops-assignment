name: DevOps Assignment CI

on:
    push:
        branches: [ main ]
    pull_request:
        branches: [ main ]

jobs:
    build-and-test:
        runs-on: ubuntu-latest

        steps:
            # Step 1: checkout the code
            - name: Checkout code
              uses: actions/checkout@v3

            # Generate dummy cert for CI
            - name: Generate SSL Certificates
              run: |
                mkdir -p nginx_server
                            
                # Generate temporary self-signed certs so Docker build succeeds
                openssl req -x509 -nodes -days 365 -newkey rsa:2048 \
                -keyout nginx_server/nginx.key \
                -out nginx_server/nginx.crt \
                -subj "/C=US/ST=State/L=City/O=DevOps/OU=GithubActions/CN=localhost"

            # Step 2: Run the tests
            - name: Build and run docker compose
              run: docker compose up --build --exit-code-from tester

            # Test succeeded
            - name: Create success file
              if: success()
              run: echo "Tests Passed Successfully" > succeeded

            - name: Upload success artifact
              if: success()
              uses: actions/upload-artifact@v4
              with:
                name: test-result-success
                path: succeeded

            # Test failed
            - name: Create failure file
              if: failure()
              run: echo "Tests Failed" > fail

            - name: Upload fail artifact
              if: failure()
              uses: actions/upload-artifact@v4
              with:
                name: test-result-fail
                path: fail
